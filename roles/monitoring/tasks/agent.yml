---
# roles/monitoring/tasks/agent.yml
# Install and configure Zabbix Agent 2 with TLS-PSK

- name: Download Zabbix repo package
  ansible.builtin.apt:
    deb: "{{ zabbix_repo_url }}"
    state: present

- name: Install Zabbix Agent 2
  ansible.builtin.apt:
    name: "{{ zabbix_agent_package }}"
    state: present
    update_cache: true

- name: Generate PSK identity
  ansible.builtin.set_fact:
    zabbix_psk_identity: "{{ kunde_id }}-{{ inventory_hostname }}"
  when: zabbix_psk_identity | length == 0

- name: Generate PSK key
  ansible.builtin.set_fact:
    zabbix_psk_key: "{{ lookup('password', '/dev/null chars=hexdigits length=64') | lower }}"
  when: zabbix_psk_key | length == 0

- name: Generate agent hostname
  ansible.builtin.set_fact:
    zabbix_agent_hostname: "{{ kunde_id }}-{{ inventory_hostname }}"
  when: zabbix_agent_hostname | length == 0

- name: Deploy Zabbix Agent config
  ansible.builtin.template:
    src: zabbix_agent2.conf.j2
    dest: "{{ zabbix_agent_config }}"
    mode: "0644"
  notify: restart zabbix agent

- name: Deploy PSK file
  ansible.builtin.copy:
    content: "{{ zabbix_psk_key }}"
    dest: "{{ zabbix_agent_psk_file }}"
    mode: "0600"
    owner: zabbix
    group: zabbix
  notify: restart zabbix agent

- name: Enable and start Zabbix Agent
  ansible.builtin.systemd:
    name: "{{ zabbix_agent_service }}"
    state: started
    enabled: true

- name: Allow Zabbix Agent port on wt0 (Netbird)
  community.general.ufw:
    rule: allow
    port: "{{ zabbix_agent_port }}"
    proto: tcp
    interface: wt0
    direction: in
  when: ansible_facts.interfaces | default([]) | select('equalto', 'wt0') | list | length > 0

- name: Store PSK credentials
  ansible.builtin.include_role:
    name: credentials
    tasks_from: store.yml
  vars:
    vw_api_url: "{{ loco.vaultwarden.url }}"
    credential_name: "{{ kunde_name | default(kunde_id) }} â€” Zabbix PSK ({{ zabbix_agent_hostname }})"
    credential_username: "{{ zabbix_psk_identity }}"
    credential_password: "{{ zabbix_psk_key }}"
    credential_notes: "Zabbix Agent TLS-PSK. Host: {{ zabbix_agent_hostname }}. Deployed: {{ ansible_date_time.iso8601 }}"
  when: loco is defined
