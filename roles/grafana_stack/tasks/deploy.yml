---
# roles/grafana_stack/tasks/deploy.yml

- name: Create Grafana Stack directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ grafana_stack_path }}"
    - "{{ grafana_stack_path }}/grafana-data"
    - "{{ grafana_stack_path }}/prometheus-data"
    - "{{ grafana_stack_path }}/loki-data"
    - "{{ grafana_stack_path }}/prometheus-targets"
    - "{{ grafana_stack_path }}/provisioning"
    - "{{ grafana_stack_path }}/provisioning/datasources"

- name: Set Grafana data directory ownership (UID 472 = grafana)
  ansible.builtin.file:
    path: "{{ grafana_stack_path }}/grafana-data"
    owner: "472"
    group: "472"
    recurse: true

- name: Set Loki data directory ownership (UID 10001 = loki)
  ansible.builtin.file:
    path: "{{ grafana_stack_path }}/loki-data"
    owner: "10001"
    group: "10001"
    recurse: true

- name: Generate Grafana admin password
  ansible.builtin.set_fact:
    grafana_admin_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: grafana_admin_password | length == 0

- name: Deploy Grafana Stack docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ grafana_stack_path }}/docker-compose.yml"
    mode: "0644"

- name: Deploy Prometheus config
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ grafana_stack_path }}/prometheus.yml"
    mode: "0644"
  notify: restart prometheus

- name: Deploy Loki config
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ grafana_stack_path }}/loki-config.yml"
    mode: "0644"
  notify: restart loki

- name: Deploy Grafana datasources provisioning
  ansible.builtin.template:
    src: datasources.yml.j2
    dest: "{{ grafana_stack_path }}/provisioning/datasources/datasources.yml"
    mode: "0644"
  notify: restart grafana

- name: Start Grafana Stack
  community.docker.docker_compose_v2:
    project_src: "{{ grafana_stack_path }}"
    state: present

- name: Wait for Grafana to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ grafana_port }}{{ grafana_health_path }}"
    method: GET
    status_code: [200]
  register: grafana_health
  until: grafana_health.status == 200
  retries: 30
  delay: 5

- name: Store Grafana admin credentials
  ansible.builtin.include_role:
    name: credentials
    tasks_from: store.yml
  vars:
    vw_api_url: "{{ loco.vaultwarden.url }}"
    credential_name: "Master â€” Grafana Admin"
    credential_username: "{{ grafana_admin_user }}"
    credential_password: "{{ grafana_admin_password }}"
    credential_uri: "https://{{ grafana_domain }}"
    credential_notes: "Grafana admin credentials. Deployed: {{ ansible_date_time.iso8601 }}"
  when: loco is defined
