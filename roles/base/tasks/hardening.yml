---
# roles/base/tasks/hardening.yml
# Kernel hardening (sysctl) + unattended-upgrades
# LXC-compatible: only network params in containers

# Network hardening — works in both LXC and bare-metal/VM
- name: Apply network sysctl hardening
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    reload: true
  loop:
    - { name: "net.ipv4.conf.all.rp_filter", value: "1" }
    - { name: "net.ipv4.conf.default.rp_filter", value: "1" }
    - { name: "net.ipv4.tcp_syncookies", value: "1" }
    - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.accept_source_route", value: "0" }
    - { name: "net.ipv4.conf.default.accept_source_route", value: "0" }
    - { name: "net.ipv6.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv6.conf.default.accept_redirects", value: "0" }

# Kernel + filesystem hardening — bare-metal/VM ONLY (not possible in LXC)
- name: Apply kernel sysctl hardening (non-LXC only)
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    reload: true
  loop:
    - { name: "kernel.randomize_va_space", value: "2" }
    - { name: "fs.suid_dumpable", value: "0" }
    - { name: "fs.protected_hardlinks", value: "1" }
    - { name: "fs.protected_symlinks", value: "1" }
  when: not is_lxc

# USB disable — bare-metal only (LXC has no USB subsystem)
- name: Disable USB storage (non-LXC only)
  ansible.builtin.copy:
    content: "install usb-storage /bin/true\n"
    dest: /etc/modprobe.d/disable-usb-storage.conf
    mode: "0644"
  when: not is_lxc

# Unattended upgrades
- name: Enable unattended-upgrades
  ansible.builtin.debconf:
    name: unattended-upgrades
    question: unattended-upgrades/enable_auto_updates
    vtype: boolean
    value: "true"
  when: unattended_upgrades_enabled

- name: Configure unattended-upgrades for security only
  ansible.builtin.copy:
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    mode: "0644"
  when: unattended_upgrades_enabled
