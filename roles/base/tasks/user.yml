---
# roles/base/tasks/user.yml
# Create admin user with SSH key and NOPASSWD sudo

- name: Create admin user
  ansible.builtin.user:
    name: "{{ admin_user }}"
    shell: "{{ admin_user_shell }}"
    groups: sudo
    append: true
    state: present

- name: Grant NOPASSWD sudo
  ansible.builtin.copy:
    content: "{{ admin_user }} ALL=(ALL) NOPASSWD: ALL\n"
    dest: "/etc/sudoers.d/{{ admin_user }}"
    mode: "0440"
    validate: "visudo -cf %s"

- name: Deploy SSH authorized keys
  ansible.posix.authorized_key:
    user: "{{ admin_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ admin_ssh_pubkeys }}"
  when: admin_ssh_pubkeys | length > 0
