---
# roles/credentials/tasks/store.yml
# Store a credential in Vaultwarden via vw-credentials.py helper.
#
# The script handles the full Bitwarden protocol:
# - Auto-creates a service user on first run (via admin invite + register)
# - Logs in and gets JWT token
# - Encrypts and stores cipher with proper client-side encryption
# - Idempotent: updates existing ciphers by name

- name: Read Vaultwarden admin token from file
  ansible.builtin.slurp:
    src: "{{ vw_admin_token_path }}"
  register: _vw_token_raw
  delegate_to: "{{ groups['all'][0] }}"
  when: vw_admin_token | default('') | length == 0

- name: Set Vaultwarden admin token
  ansible.builtin.set_fact:
    vw_admin_token: "{{ _vw_token_raw.content | b64decode | trim }}"
  when: vw_admin_token | default('') | length == 0 and _vw_token_raw is defined

- name: Store credential in Vaultwarden
  ansible.builtin.command:
    cmd: >-
      python3 {{ playbook_dir }}/../scripts/vw-credentials.py
      --url "{{ vw_api_url }}"
      --admin-token "{{ vw_admin_token }}"
      --action store
      --name "{{ credential_name }}"
      --username "{{ credential_username }}"
      --password "{{ credential_password }}"
      --uri "{{ credential_uri | default('') }}"
      --notes "{{ credential_notes | default('') }}"
  register: _vw_store_result
  changed_when: "'created' in _vw_store_result.stdout"
  no_log: true
  when:
    - credential_name | length > 0
    - vw_admin_token | default('') | length > 0
    - vw_api_url | default('') | length > 0

- name: Credential store result
  ansible.builtin.debug:
    msg: "{{ credential_name }}: {{ (_vw_store_result.stdout | from_json).action | default('skipped') }}"
  when:
    - _vw_store_result is defined
    - _vw_store_result is not skipped
    - _vw_store_result.rc | default(1) == 0
  failed_when: false
