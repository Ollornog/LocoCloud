---
# roles/credentials/tasks/store.yml
# Store a credential in Admin-Vaultwarden via API

- name: Read Vaultwarden API token
  ansible.builtin.slurp:
    src: "{{ vw_api_token_path }}"
  register: vw_token_raw
  delegate_to: "{{ groups['all'][0] }}"

- name: Set Vaultwarden API token
  ansible.builtin.set_fact:
    vw_api_token: "{{ vw_token_raw.content | b64decode | trim }}"

- name: Store credential in Vaultwarden
  ansible.builtin.uri:
    url: "{{ vw_api_url }}/api/ciphers"
    method: POST
    headers:
      Authorization: "Bearer {{ vw_api_token }}"
    body_format: json
    body:
      type: 1
      name: "{{ credential_name }}"
      login:
        username: "{{ credential_username }}"
        password: "{{ credential_password }}"
        uris: "{{ [{'uri': credential_uri}] if credential_uri | length > 0 else [] }}"
      notes: "{{ credential_notes }}"
      folderId: "{{ credential_folder_id if credential_folder_id | length > 0 else omit }}"
      organizationId: "{{ vw_organization_id if vw_organization_id | length > 0 else omit }}"
    status_code: [200, 201]
  when: credential_name | length > 0
