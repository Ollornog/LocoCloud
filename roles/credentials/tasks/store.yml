---
# roles/credentials/tasks/store.yml
# Store a credential in Vaultwarden via vw-credentials.py helper.
#
# The script handles the full Bitwarden protocol:
# - Auto-creates a service user on first run (via admin invite + register)
# - Logs in and gets JWT token
# - Encrypts and stores cipher with proper client-side encryption
# - Idempotent: updates existing ciphers by name

- name: Read Vaultwarden admin token from file
  ansible.builtin.slurp:
    src: "{{ vw_admin_token_path }}"
  register: _vw_token_raw
  delegate_to: "{{ groups['all'][0] }}"
  when: vw_admin_token | default('') | length == 0

- name: Set Vaultwarden admin token
  ansible.builtin.set_fact:
    vw_admin_token: "{{ _vw_token_raw.content | b64decode | trim }}"
  when: vw_admin_token | default('') | length == 0 and _vw_token_raw is defined

- name: Write credential request to temp file
  ansible.builtin.copy:
    content: >-
      {{ {
        'url': vw_api_url,
        'admin_token': vw_admin_token,
        'action': 'store',
        'name': credential_name,
        'username': credential_username,
        'password': credential_password,
        'uri': credential_uri | default(''),
        'notes': credential_notes | default('')
      } | to_json }}
    dest: /tmp/.vw-cred-request.json
    mode: "0600"
  no_log: true
  when:
    - credential_name | length > 0
    - vw_admin_token | default('') | length > 0
    - vw_api_url | default('') | length > 0

- name: Store credential in Vaultwarden
  ansible.builtin.command:
    cmd: python3 {{ playbook_dir }}/../scripts/vw-credentials.py --from-file /tmp/.vw-cred-request.json
  register: _vw_store_result
  changed_when: "'created' in (_vw_store_result.stdout | default(''))"
  when:
    - credential_name | length > 0
    - vw_admin_token | default('') | length > 0
    - vw_api_url | default('') | length > 0

- name: Remove temp credential file
  ansible.builtin.file:
    path: /tmp/.vw-cred-request.json
    state: absent

- name: Show credential store error
  ansible.builtin.debug:
    msg: "vw-credentials.py failed for '{{ credential_name }}': {{ _vw_store_result.stderr | default('unknown') }}"
  when:
    - _vw_store_result is defined
    - _vw_store_result is not skipped
    - _vw_store_result.rc | default(0) != 0

- name: Credential store result
  ansible.builtin.debug:
    msg: "{{ credential_name }}: {{ (_vw_store_result.stdout | from_json).action | default('stored') }}"
  when:
    - _vw_store_result is defined
    - _vw_store_result is not skipped
    - _vw_store_result.rc | default(1) == 0
  failed_when: false
