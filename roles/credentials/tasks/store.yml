---
# roles/credentials/tasks/store.yml
# Store a credential in Vaultwarden via vw-credentials.py helper.
#
# The script handles the full Bitwarden protocol:
# - Auto-creates a service user on first run (direct registration)
# - Logs in and gets JWT token
# - Encrypts and stores cipher with proper client-side encryption
# - Idempotent: updates existing ciphers by name
#
# Recovery: On first run two settings may block the service user:
#   1. SIGNUPS_ALLOWED=false → registration fails
#   2. SSO_ONLY=true → password-based login fails ("SSO sign-in is required")
# We detect either error, temporarily toggle both settings in .env, recreate
# the container (docker restart does NOT re-read env_file), retry, then restore.

- name: Read Vaultwarden admin token from file
  ansible.builtin.slurp:
    src: "{{ vw_admin_token_path }}"
  register: _vw_token_raw
  delegate_to: "{{ groups['all'][0] }}"
  when: vw_admin_token | default('') | length == 0

- name: Set Vaultwarden admin token
  ansible.builtin.set_fact:
    vw_admin_token: "{{ _vw_token_raw.content | b64decode | trim }}"
  when: vw_admin_token | default('') | length == 0 and _vw_token_raw is defined

- name: Write credential request to temp file
  ansible.builtin.copy:
    content: >-
      {{ {
        'url': vw_api_url,
        'admin_token': vw_admin_token,
        'action': 'store',
        'name': credential_name,
        'username': credential_username,
        'password': credential_password,
        'uri': credential_uri | default(''),
        'notes': credential_notes | default('')
      } | to_json }}
    dest: /tmp/.vw-cred-request.json
    mode: "0600"
  no_log: true
  when:
    - credential_name | length > 0
    - vw_admin_token | default('') | length > 0
    - vw_api_url | default('') | length > 0

- name: Store credential in Vaultwarden
  ansible.builtin.command:
    cmd: python3 {{ playbook_dir }}/../scripts/vw-credentials.py --from-file /tmp/.vw-cred-request.json
  register: _vw_store_result
  changed_when: "'created' in (_vw_store_result.stdout | default(''))"
  failed_when: false
  when:
    - credential_name | length > 0
    - vw_admin_token | default('') | length > 0
    - vw_api_url | default('') | length > 0

# Determine if recovery is needed (signups blocked OR SSO blocks password login).
# Using set_fact so the flag stays stable — if _vw_store_result gets overwritten
# by the retry, the block/always `when` conditions still evaluate correctly.
- name: Determine if credential storage needs recovery
  ansible.builtin.set_fact:
    _vw_needs_recovery: >-
      {{ _vw_store_result is defined
         and _vw_store_result is not skipped
         and _vw_store_result.rc | default(0) != 0
         and ('Registration not allowed' in (_vw_store_result.stderr | default(''))
              or 'SSO sign-in is required' in (_vw_store_result.stderr | default(''))) }}

- name: Check if SSO_ONLY is configured in Vaultwarden .env
  ansible.builtin.command:
    cmd: grep -c '^SSO_ONLY=' "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}/.env"
  register: _vw_has_sso_only
  failed_when: false
  changed_when: false
  when: _vw_needs_recovery | bool

# Toggle both SIGNUPS_ALLOWED and SSO_ONLY proactively so that registration
# AND login succeed in a single retry (avoids two-round failure).
- name: Temporarily adjust Vaultwarden for service user access
  when: _vw_needs_recovery | bool
  block:
    - name: Enable signups in Vaultwarden .env
      ansible.builtin.lineinfile:
        path: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}/.env"
        regexp: '^SIGNUPS_ALLOWED='
        line: 'SIGNUPS_ALLOWED=true'

    - name: Disable SSO_ONLY in Vaultwarden .env
      ansible.builtin.lineinfile:
        path: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}/.env"
        regexp: '^SSO_ONLY='
        line: 'SSO_ONLY=false'
      when: _vw_has_sso_only.rc | default(1) == 0

    - name: Recreate Vaultwarden to apply env changes
      community.docker.docker_compose_v2:
        project_src: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}"
        state: absent

    - name: Start Vaultwarden with adjusted settings
      community.docker.docker_compose_v2:
        project_src: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}"
        state: present

    - name: Wait for Vaultwarden to be ready
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ vaultwarden_port | default(8222) }}"
        delay: 3
        timeout: 30

    - name: Retry storing credential with adjusted settings
      ansible.builtin.command:
        cmd: python3 {{ playbook_dir }}/../scripts/vw-credentials.py --from-file /tmp/.vw-cred-request.json
      register: _vw_store_result
      changed_when: "'created' in (_vw_store_result.stdout | default(''))"

  rescue:
    - name: Log recovery failure
      ansible.builtin.debug:
        msg: "Credential storage failed after recovery: {{ _vw_store_result.stderr | default('unknown') }}"

  always:
    - name: Restore SIGNUPS_ALLOWED=false in Vaultwarden .env
      ansible.builtin.lineinfile:
        path: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}/.env"
        regexp: '^SIGNUPS_ALLOWED='
        line: 'SIGNUPS_ALLOWED=false'

    - name: Restore SSO_ONLY=true in Vaultwarden .env
      ansible.builtin.lineinfile:
        path: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}/.env"
        regexp: '^SSO_ONLY='
        line: 'SSO_ONLY=true'
      when: _vw_has_sso_only.rc | default(1) == 0

    - name: Recreate Vaultwarden to restore settings
      community.docker.docker_compose_v2:
        project_src: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}"
        state: absent

    - name: Start Vaultwarden with restored settings
      community.docker.docker_compose_v2:
        project_src: "{{ vaultwarden_stack_path | default('/opt/stacks/vaultwarden') }}"
        state: present

    - name: Wait for Vaultwarden after settings restored
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ vaultwarden_port | default(8222) }}"
        delay: 3
        timeout: 30

- name: Remove temp credential file
  ansible.builtin.file:
    path: /tmp/.vw-cred-request.json
    state: absent

- name: Fail if credential storage failed
  ansible.builtin.fail:
    msg: "vw-credentials.py failed for '{{ credential_name }}': {{ _vw_store_result.stderr | default('unknown') }}"
  when:
    - _vw_store_result is defined
    - _vw_store_result is not skipped
    - _vw_store_result.rc | default(0) != 0

- name: Credential store result
  ansible.builtin.debug:
    msg: "{{ credential_name }}: {{ (_vw_store_result.stdout | from_json).action | default('stored') }}"
  when:
    - _vw_store_result is defined
    - _vw_store_result is not skipped
    - _vw_store_result.rc | default(1) == 0
  failed_when: false
