---
# roles/credentials/tasks/store.yml
# Store a credential â€” either via bw CLI (if available) or locally for later import.
#
# During initial bootstrap, Vaultwarden has no user account yet.
# Credentials are saved to a local file and can be imported later
# via: ansible-playbook playbooks/import-credentials.yml

- name: Ensure pending credentials file exists
  ansible.builtin.file:
    path: "{{ credentials_pending_file }}"
    state: touch
    mode: "0600"
    modification_time: preserve
    access_time: preserve

- name: Read existing pending credentials
  ansible.builtin.slurp:
    src: "{{ credentials_pending_file }}"
  register: _creds_raw

- name: Parse existing pending credentials
  ansible.builtin.set_fact:
    _creds_existing: "{{ (_creds_raw.content | b64decode | from_json) if (_creds_raw.content | b64decode | trim | length > 0) else [] }}"

- name: Check if credential already pending
  ansible.builtin.set_fact:
    _cred_already_pending: "{{ _creds_existing | selectattr('name', 'equalto', credential_name) | list | length > 0 }}"

- name: Build credential entry
  ansible.builtin.set_fact:
    _cred_entry:
      name: "{{ credential_name }}"
      username: "{{ credential_username }}"
      password: "{{ credential_password }}"
      uri: "{{ credential_uri | default('') }}"
      notes: "{{ credential_notes | default('') }}"
      folder: "{{ credential_folder_name | default('') }}"
      timestamp: "{{ ansible_facts.date_time.iso8601 | default('') }}"
  no_log: true

- name: Update existing or append new credential
  ansible.builtin.set_fact:
    _creds_updated: >-
      {{
        (_creds_existing | rejectattr('name', 'equalto', credential_name) | list)
        + [_cred_entry]
      }}
  no_log: true

- name: Write pending credentials file
  ansible.builtin.copy:
    content: "{{ _creds_updated | to_nice_json }}"
    dest: "{{ credentials_pending_file }}"
    mode: "0600"
  no_log: true

# Try bw CLI import if available and authenticated
- name: Check if bw CLI is available
  ansible.builtin.command: which bw
  register: _bw_check
  failed_when: false
  changed_when: false

- name: Check bw CLI login status
  ansible.builtin.command: bw status
  register: _bw_status
  failed_when: false
  changed_when: false
  environment:
    BITWARDENCLI_APPDATA_DIR: "{{ bw_appdata_dir | default('/root/.bw') }}"
    NODE_EXTRA_CA_CERTS: "{{ bw_ca_cert | default(omit) }}"
  when: _bw_check.rc == 0

- name: Parse bw status
  ansible.builtin.set_fact:
    _bw_logged_in: "{{ (_bw_status.stdout | from_json).status | default('unauthenticated') == 'unlocked' }}"
  when: _bw_check.rc == 0 and _bw_status.rc == 0
  failed_when: false

- name: Store credential via bw CLI
  when:
    - _bw_check.rc | default(1) == 0
    - _bw_logged_in | default(false)
  block:
    - name: Check if item already exists in vault
      ansible.builtin.command: >
        bw list items --search "{{ credential_name }}"
      register: _bw_existing
      changed_when: false
      environment:
        BITWARDENCLI_APPDATA_DIR: "{{ bw_appdata_dir | default('/root/.bw') }}"
        BW_SESSION: "{{ bw_session | default(omit) }}"

    - name: Check for exact name match
      ansible.builtin.set_fact:
        _bw_item_exists: "{{ (_bw_existing.stdout | from_json | selectattr('name', 'equalto', credential_name) | list | length) > 0 }}"

    - name: Create item template and store in vault
      ansible.builtin.shell: |
        echo '{{ _bw_item_json | to_json }}' | bw encode | bw create item
      args:
        executable: /bin/bash
      vars:
        _bw_item_json:
          type: 1
          name: "{{ credential_name }}"
          notes: "{{ credential_notes | default('') }}"
          login:
            username: "{{ credential_username }}"
            password: "{{ credential_password }}"
            uris: "{{ [{'match': None, 'uri': credential_uri}] if (credential_uri | default('') | length > 0) else [] }}"
      environment:
        BITWARDENCLI_APPDATA_DIR: "{{ bw_appdata_dir | default('/root/.bw') }}"
        BW_SESSION: "{{ bw_session | default(omit) }}"
      when: not _bw_item_exists
      no_log: true
      register: _bw_create_result

    - name: Remove credential from pending file after successful import
      ansible.builtin.copy:
        content: "{{ _creds_existing | rejectattr('name', 'equalto', credential_name) | list | to_nice_json }}"
        dest: "{{ credentials_pending_file }}"
        mode: "0600"
      when: _bw_create_result is not skipped

- name: Credential stored locally (bw CLI not available)
  ansible.builtin.debug:
    msg: >-
      Credential '{{ credential_name }}' saved to {{ credentials_pending_file }}.
      Import later: ansible-playbook playbooks/import-credentials.yml
  when: _bw_check.rc | default(1) != 0 or not (_bw_logged_in | default(false))
