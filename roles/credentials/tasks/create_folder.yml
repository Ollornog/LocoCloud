---
# roles/credentials/tasks/create_folder.yml
# Create a folder in Vaultwarden for organizing credentials (idempotent)
# Set variable: credential_folder_name before including

- name: Read Vaultwarden API token
  ansible.builtin.slurp:
    src: "{{ vw_api_token_path }}"
  register: vw_token_raw
  delegate_to: "{{ groups['all'][0] }}"
  when: vw_api_token is not defined

- name: Set Vaultwarden API token
  ansible.builtin.set_fact:
    vw_api_token: "{{ vw_token_raw.content | b64decode | trim }}"
  when: vw_api_token is not defined

# Check if folder already exists before creating
- name: List existing folders
  ansible.builtin.uri:
    url: "{{ vw_api_url }}/api/folders"
    method: GET
    headers:
      Authorization: "Bearer {{ vw_api_token }}"
    status_code: [200]
  register: vw_existing_folders

- name: Find existing folder by name
  ansible.builtin.set_fact:
    vw_folder_match: "{{ vw_existing_folders.json.data | default([]) | selectattr('name', 'equalto', credential_folder_name) | list }}"

- name: Create folder in Vaultwarden
  ansible.builtin.uri:
    url: "{{ vw_api_url }}/api/folders"
    method: POST
    headers:
      Authorization: "Bearer {{ vw_api_token }}"
    body_format: json
    body:
      name: "{{ credential_folder_name }}"
    status_code: [200, 201]
  register: vw_folder_result
  when: vw_folder_match | length == 0

- name: Register folder ID (new)
  ansible.builtin.set_fact:
    credential_folder_id: "{{ vw_folder_result.json.id }}"
  when: vw_folder_match | length == 0

- name: Register folder ID (existing)
  ansible.builtin.set_fact:
    credential_folder_id: "{{ vw_folder_match[0].id }}"
  when: vw_folder_match | length > 0
