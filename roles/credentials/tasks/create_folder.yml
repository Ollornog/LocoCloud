---
# roles/credentials/tasks/create_folder.yml
# Create a folder in Vaultwarden via bw CLI (idempotent)
# Set variable: credential_folder_name before including

- name: Check if bw CLI is available
  ansible.builtin.command: which bw
  register: _bw_check
  failed_when: false
  changed_when: false

- name: Create folder via bw CLI
  when: _bw_check.rc == 0
  block:
    - name: List existing folders
      ansible.builtin.command: bw list folders
      register: _bw_folders
      changed_when: false
      environment:
        BITWARDENCLI_APPDATA_DIR: "{{ bw_appdata_dir | default('/root/.bw') }}"
        BW_SESSION: "{{ bw_session | default(omit) }}"

    - name: Check if folder already exists
      ansible.builtin.set_fact:
        _folder_exists: "{{ (_bw_folders.stdout | from_json | selectattr('name', 'equalto', credential_folder_name) | list | length) > 0 }}"
        _folder_id: "{{ (_bw_folders.stdout | from_json | selectattr('name', 'equalto', credential_folder_name) | list | first).id | default('') }}"
      when: _bw_folders.rc == 0

    - name: Create folder
      ansible.builtin.shell: |
        echo '{"name":"{{ credential_folder_name }}"}' | bw encode | bw create folder
      args:
        executable: /bin/bash
      environment:
        BITWARDENCLI_APPDATA_DIR: "{{ bw_appdata_dir | default('/root/.bw') }}"
        BW_SESSION: "{{ bw_session | default(omit) }}"
      register: _bw_folder_result
      when: not _folder_exists | default(true)

    - name: Set folder ID
      ansible.builtin.set_fact:
        credential_folder_id: "{{ (_bw_folder_result.stdout | from_json).id if _bw_folder_result is changed else _folder_id }}"

- name: Skip folder creation (bw CLI not available)
  ansible.builtin.debug:
    msg: "bw CLI not available â€” folder '{{ credential_folder_name }}' not created. Will be created during import."
  when: _bw_check.rc | default(1) != 0
