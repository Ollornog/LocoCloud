---
# roles/credentials/tasks/create_folder.yml
# Create a folder in Vaultwarden for organizing credentials
# Set variable: credential_folder_name before including

- name: Read Vaultwarden API token
  ansible.builtin.slurp:
    src: "{{ vw_api_token_path }}"
  register: vw_token_raw
  delegate_to: "{{ groups['all'][0] }}"
  when: vw_api_token is not defined

- name: Set Vaultwarden API token
  ansible.builtin.set_fact:
    vw_api_token: "{{ vw_token_raw.content | b64decode | trim }}"
  when: vw_api_token is not defined

- name: Create folder in Vaultwarden
  ansible.builtin.uri:
    url: "{{ vw_api_url }}/api/folders"
    method: POST
    headers:
      Authorization: "Bearer {{ vw_api_token }}"
    body_format: json
    body:
      name: "{{ credential_folder_name }}"
    status_code: [200, 201]
  register: vw_folder_result

- name: Register folder ID
  ansible.builtin.set_fact:
    credential_folder_id: "{{ vw_folder_result.json.id }}"
