---
# roles/apps/stirling_pdf/tasks/oidc.yml
# Register OIDC client in PocketID for Stirling PDF

- name: Create OIDC client in PocketID
  ansible.builtin.uri:
    url: "https://{{ stirling_pdf_oidc_provider_url | regex_replace('^https?://', '') }}/api/oidc/clients"
    method: POST
    headers:
      X-API-Key: "{{ loco.pocketid.api_token }}"
    body_format: json
    body:
      name: "Stirling PDF ({{ kunde_name }})"
      callbackURLs:
        - "https://{{ stirling_pdf_domain }}/login/oauth2/code/pocketid"
    status_code: [200, 201]
  register: spdf_oidc_client
  when:
    - stirling_pdf_oidc_client_id | length == 0
    - loco.pocketid.api_token | default('') | length > 0

- name: Set OIDC client ID from API response
  ansible.builtin.set_fact:
    stirling_pdf_oidc_client_id: "{{ spdf_oidc_client.json.id }}"
  when: spdf_oidc_client is not skipped and spdf_oidc_client is changed

- name: Generate OIDC client secret
  ansible.builtin.uri:
    url: "https://{{ stirling_pdf_oidc_provider_url | regex_replace('^https?://', '') }}/api/oidc/clients/{{ stirling_pdf_oidc_client_id }}/secret"
    method: POST
    headers:
      X-API-Key: "{{ loco.pocketid.api_token }}"
    status_code: 200
  register: spdf_secret_result
  when: stirling_pdf_oidc_client_id | default('') | length > 0

- name: Set OIDC client secret
  ansible.builtin.set_fact:
    stirling_pdf_oidc_client_secret: "{{ spdf_secret_result.json.secret }}"
  when: spdf_secret_result is defined and spdf_secret_result is not skipped

- name: Store Stirling PDF OIDC credentials
  ansible.builtin.include_role:
    name: credentials
    tasks_from: store.yml
  vars:
    vw_api_url: "{{ loco.vaultwarden.url }}"
    credential_name: "{{ kunde_name }} â€” Stirling PDF OIDC Client"
    credential_username: "{{ stirling_pdf_oidc_client_id }}"
    credential_password: "{{ stirling_pdf_oidc_client_secret }}"
    credential_uri: "https://{{ stirling_pdf_domain }}"
    credential_notes: "PocketID OIDC client for Stirling PDF. Deployed: {{ ansible_facts.date_time.iso8601 }}"
  when:
    - loco is defined
    - stirling_pdf_oidc_client_id | length > 0

- name: Redeploy Stirling PDF .env with OIDC credentials
  ansible.builtin.template:
    src: env.j2
    dest: "{{ stirling_pdf_stack_path }}/.env"
    mode: "0600"
  notify: restart stirling-pdf

- name: Apply OIDC config immediately
  ansible.builtin.meta: flush_handlers
