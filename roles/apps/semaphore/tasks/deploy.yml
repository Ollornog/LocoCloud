---
# roles/apps/semaphore/tasks/deploy.yml

- name: Create Semaphore directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ semaphore_stack_path }}"
    - "{{ semaphore_data_path }}"
    - "{{ semaphore_data_path }}/db"

- name: Read existing Semaphore .env
  ansible.builtin.slurp:
    src: "{{ semaphore_stack_path }}/.env"
  register: semaphore_existing_env
  failed_when: false

# Detect stale DB from previous deployment with wrong env var name
# (SEMAPHORE_DB_NAME instead of SEMAPHORE_DB). PostgreSQL data must be
# reset because the password was regenerated and no longer matches.
- name: Check for stale DB from broken env config
  ansible.builtin.set_fact:
    _semaphore_db_stale: "{{ semaphore_existing_env is not failed and semaphore_existing_env.content is defined and (semaphore_existing_env.content | b64decode is search('SEMAPHORE_DB_NAME=')) }}"

- name: Stop stale Semaphore containers
  community.docker.docker_compose_v2:
    project_src: "{{ semaphore_stack_path }}"
    state: absent
  when: _semaphore_db_stale | bool

- name: Remove stale PostgreSQL data (password mismatch from previous run)
  ansible.builtin.file:
    path: "{{ semaphore_data_path }}/db"
    state: absent
  when: _semaphore_db_stale | bool

- name: Recreate DB directory after cleanup
  ansible.builtin.file:
    path: "{{ semaphore_data_path }}/db"
    state: directory
    mode: "0755"
  when: _semaphore_db_stale | bool

# Preserve existing passwords across runs. PostgreSQL ignores
# POSTGRES_PASSWORD when the data directory already exists, so we must
# reuse the password from the initial deployment.
- name: Extract existing DB password
  ansible.builtin.set_fact:
    semaphore_db_password: "{{ semaphore_existing_env.content | b64decode | regex_search('SEMAPHORE_DB_PASS=(.+)', '\\1') | first }}"
  when:
    - semaphore_db_password | length == 0
    - not (_semaphore_db_stale | bool)
    - semaphore_existing_env is not failed
    - semaphore_existing_env.content is defined
    - semaphore_existing_env.content | b64decode is search('SEMAPHORE_DB_PASS=')

- name: Generate Semaphore DB password
  ansible.builtin.set_fact:
    semaphore_db_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: semaphore_db_password | length == 0

- name: Extract existing admin password
  ansible.builtin.set_fact:
    semaphore_admin_password: "{{ semaphore_existing_env.content | b64decode | regex_search('SEMAPHORE_ADMIN_PASSWORD=(.+)', '\\1') | first }}"
  when:
    - semaphore_admin_password | length == 0
    - not (_semaphore_db_stale | bool)
    - semaphore_existing_env is not failed
    - semaphore_existing_env.content is defined
    - semaphore_existing_env.content | b64decode is search('SEMAPHORE_ADMIN_PASSWORD=')

- name: Generate Semaphore admin password
  ansible.builtin.set_fact:
    semaphore_admin_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: semaphore_admin_password | length == 0

- name: Extract existing access key encryption
  ansible.builtin.set_fact:
    semaphore_access_key_encryption: "{{ semaphore_existing_env.content | b64decode | regex_search('SEMAPHORE_ACCESS_KEY_ENCRYPTION=(.+)', '\\1') | first }}"
  when:
    - semaphore_access_key_encryption | length == 0
    - not (_semaphore_db_stale | bool)
    - semaphore_existing_env is not failed
    - semaphore_existing_env.content is defined
    - semaphore_existing_env.content | b64decode is search('SEMAPHORE_ACCESS_KEY_ENCRYPTION=')

- name: Generate Semaphore access key encryption
  ansible.builtin.set_fact:
    semaphore_access_key_encryption: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: semaphore_access_key_encryption | length == 0

- name: Deploy Semaphore docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ semaphore_stack_path }}/docker-compose.yml"
    mode: "0644"

- name: Deploy Semaphore .env
  ansible.builtin.template:
    src: env.j2
    dest: "{{ semaphore_stack_path }}/.env"
    mode: "0600"

- name: Start Semaphore
  community.docker.docker_compose_v2:
    project_src: "{{ semaphore_stack_path }}"
    state: present

# Auto-recovery: detect password mismatch after start. PostgreSQL ignores
# POSTGRES_PASSWORD changes when data directory already exists, so a previous
# run with a different password leaves the DB in an unrecoverable state.
- name: Wait for Semaphore container to stabilize
  ansible.builtin.command:
    cmd: "docker inspect -f '{% raw %}{{ .State.Status }}{% endraw %}' semaphore"
  register: _semaphore_state
  changed_when: false
  retries: 3
  delay: 5
  until: _semaphore_state.stdout | default('') in ['running', 'restarting', 'exited']
  failed_when: false

- name: Check Semaphore logs for password mismatch
  ansible.builtin.command:
    cmd: docker logs semaphore --tail 50
  register: _semaphore_logs
  changed_when: false
  when: _semaphore_state.stdout | default('') != 'running'

- name: Detect PostgreSQL password mismatch
  ansible.builtin.set_fact:
    _semaphore_pw_mismatch: >-
      {{ _semaphore_state.stdout | default('') != 'running'
         and ('password authentication failed' in (_semaphore_logs.stdout | default(''))
              or 'password authentication failed' in (_semaphore_logs.stderr | default(''))) }}

- name: Reset PostgreSQL data on password mismatch
  when: _semaphore_pw_mismatch | bool
  block:
    - name: Stop Semaphore containers (password mismatch recovery)
      community.docker.docker_compose_v2:
        project_src: "{{ semaphore_stack_path }}"
        state: absent

    - name: Remove PostgreSQL data directory (password mismatch)
      ansible.builtin.file:
        path: "{{ semaphore_data_path }}/db"
        state: absent

    - name: Recreate DB directory after password reset
      ansible.builtin.file:
        path: "{{ semaphore_data_path }}/db"
        state: directory
        mode: "0755"

    - name: Generate fresh DB password after mismatch
      ansible.builtin.set_fact:
        semaphore_db_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"

    - name: Redeploy docker-compose.yml with fresh password
      ansible.builtin.template:
        src: docker-compose.yml.j2
        dest: "{{ semaphore_stack_path }}/docker-compose.yml"
        mode: "0644"

    - name: Redeploy .env with fresh password
      ansible.builtin.template:
        src: env.j2
        dest: "{{ semaphore_stack_path }}/.env"
        mode: "0600"

    - name: Start Semaphore with fresh database
      community.docker.docker_compose_v2:
        project_src: "{{ semaphore_stack_path }}"
        state: present

- name: Wait for Semaphore to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ semaphore_port }}/api/ping"
    method: GET
    status_code: [200, 204]
  register: semaphore_health
  until: semaphore_health.status in [200, 204]
  retries: 30
  delay: 5
