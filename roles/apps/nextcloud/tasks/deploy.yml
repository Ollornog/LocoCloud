---
# roles/apps/nextcloud/tasks/deploy.yml

- name: Create Nextcloud directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ nextcloud_stack_path }}"
    - "{{ nextcloud_stack_path }}/html"
    - "{{ nextcloud_stack_path }}/db"
    - "{{ nextcloud_stack_path }}/redis"
    - "{{ nextcloud_data_path }}"

- name: Generate Nextcloud DB password
  ansible.builtin.set_fact:
    nextcloud_db_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: nextcloud_db_password | length == 0

- name: Generate Nextcloud DB root password
  ansible.builtin.set_fact:
    nextcloud_db_root_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: nextcloud_db_root_password | length == 0

- name: Generate Nextcloud admin password
  ansible.builtin.set_fact:
    nextcloud_admin_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: nextcloud_admin_password | length == 0

- name: Deploy preview packages hook script
  ansible.builtin.template:
    src: install-preview-packages.sh.j2
    dest: "{{ nextcloud_stack_path }}/install-preview-packages.sh"
    mode: "0755"

- name: Deploy Nextcloud docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ nextcloud_stack_path }}/docker-compose.yml"
    mode: "0644"

- name: Deploy Nextcloud .env
  ansible.builtin.template:
    src: env.j2
    dest: "{{ nextcloud_stack_path }}/.env"
    mode: "0600"

- name: Start Nextcloud
  community.docker.docker_compose_v2:
    project_src: "{{ nextcloud_stack_path }}"
    state: present

- name: Wait for Nextcloud to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ nextcloud_port }}/status.php"
    method: GET
    status_code: 200
  register: nc_health
  until: nc_health.status == 200
  retries: 60
  delay: 10

# --- Imaginary + Preview Generator ---

- name: Install previewgenerator app
  ansible.builtin.command: >
    docker exec -u www-data nextcloud
    php occ app:install previewgenerator
  register: nc_preview_install
  changed_when: "'installed' in nc_preview_install.stdout"
  failed_when: false

- name: Enable previewgenerator app
  ansible.builtin.command: >
    docker exec -u www-data nextcloud
    php occ app:enable previewgenerator
  register: nc_preview_enable
  changed_when: "'enabled' in nc_preview_enable.stdout"
  failed_when: false

- name: Configure preview providers
  ansible.builtin.command: >
    docker exec -u www-data nextcloud
    php occ config:system:set enabledPreviewProviders {{ index }} --value="{{ item }}"
  loop: "{{ nextcloud_preview_providers }}"
  loop_control:
    index_var: index
    label: "{{ item | regex_replace('OC\\\\Preview\\\\', '') }}"
  changed_when: true

- name: Configure preview settings
  ansible.builtin.command: >
    docker exec -u www-data nextcloud
    php occ config:system:set {{ item.key }} --value="{{ item.value }}" {{ item.type | default('') }}
  loop:
    - { key: "preview_imaginary_url", value: "http://nextcloud-imaginary:9000", type: "" }
    - { key: "preview_max_x", value: "{{ nextcloud_preview_max_x }}", type: "--type=integer" }
    - { key: "preview_max_y", value: "{{ nextcloud_preview_max_y }}", type: "--type=integer" }
    - { key: "jpeg_quality", value: "{{ nextcloud_preview_jpeg_quality }}", type: "--type=integer" }
    - { key: "preview_concurrency_all", value: "{{ nextcloud_preview_concurrency_all }}", type: "--type=integer" }
    - { key: "preview_concurrency_new", value: "{{ nextcloud_preview_concurrency_new }}", type: "--type=integer" }
    - { key: "enable_previews", value: "true", type: "--type=boolean" }
    - { key: "preview_ffmpeg_path", value: "/usr/bin/ffmpeg", type: "" }
  loop_control:
    label: "{{ item.key }}"
  changed_when: true

- name: Set Nextcloud cron mode to cron
  ansible.builtin.command: >
    docker exec -u www-data nextcloud
    php occ background:cron
  register: nc_cron_mode
  changed_when: "'Set mode' in nc_cron_mode.stdout"
  failed_when: false

- name: Create preview pre-generate cron job
  ansible.builtin.cron:
    name: "nextcloud-preview-generate"
    minute: "*/10"
    job: "docker exec -u www-data nextcloud php occ preview:pre-generate > /dev/null 2>&1"
    user: root

- name: Create Nextcloud system cron job
  ansible.builtin.cron:
    name: "nextcloud-cron"
    minute: "*/5"
    job: "docker exec -u www-data nextcloud php -f /var/www/html/cron.php > /dev/null 2>&1"
    user: root

- name: Store Nextcloud credentials
  ansible.builtin.include_role:
    name: credentials
    tasks_from: store.yml
  vars:
    vw_api_url: "{{ loco.vaultwarden.url }}"
    credential_name: "{{ kunde_name }} â€” Nextcloud Admin"
    credential_username: "{{ nextcloud_admin_user }}"
    credential_password: "{{ nextcloud_admin_password }}"
    credential_uri: "https://{{ nextcloud_domain }}"
    credential_notes: "Nextcloud admin. Deployed: {{ ansible_date_time.iso8601 }}"
  when: loco is defined
