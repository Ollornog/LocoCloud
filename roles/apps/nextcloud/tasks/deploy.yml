---
# roles/apps/nextcloud/tasks/deploy.yml

- name: Create Nextcloud directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ nextcloud_stack_path }}"
    - "{{ nextcloud_stack_path }}/html"
    - "{{ nextcloud_stack_path }}/db"
    - "{{ nextcloud_stack_path }}/redis"
    - "{{ nextcloud_data_path }}"

- name: Generate Nextcloud DB password
  ansible.builtin.set_fact:
    nextcloud_db_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: nextcloud_db_password | length == 0

- name: Generate Nextcloud DB root password
  ansible.builtin.set_fact:
    nextcloud_db_root_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: nextcloud_db_root_password | length == 0

- name: Generate Nextcloud admin password
  ansible.builtin.set_fact:
    nextcloud_admin_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: nextcloud_admin_password | length == 0

- name: Deploy Nextcloud docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ nextcloud_stack_path }}/docker-compose.yml"
    mode: "0644"

- name: Deploy Nextcloud .env
  ansible.builtin.template:
    src: env.j2
    dest: "{{ nextcloud_stack_path }}/.env"
    mode: "0600"

- name: Start Nextcloud
  community.docker.docker_compose_v2:
    project_src: "{{ nextcloud_stack_path }}"
    state: present

- name: Wait for Nextcloud to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ nextcloud_port }}/status.php"
    method: GET
    status_code: 200
  register: nc_health
  until: nc_health.status == 200
  retries: 60
  delay: 10

- name: Store Nextcloud credentials
  ansible.builtin.include_role:
    name: credentials
    tasks_from: store.yml
  vars:
    vw_api_url: "{{ loco.vaultwarden.url }}"
    credential_name: "{{ kunde_name }} â€” Nextcloud Admin"
    credential_username: "{{ nextcloud_admin_user }}"
    credential_password: "{{ nextcloud_admin_password }}"
    credential_uri: "https://{{ nextcloud_domain }}"
    credential_notes: "Nextcloud admin. Deployed: {{ ansible_date_time.iso8601 }}"
  when: loco is defined
