---
# roles/backup/tasks/scripts.yml
# Deploy backup and pre-backup scripts

- name: Deploy pre-backup DB dump script
  ansible.builtin.copy:
    dest: "{{ backup_script_path }}/pre-backup.sh"
    mode: "0700"
    content: |
      #!/bin/bash
      # Pre-backup: dump all databases
      set -euo pipefail
      DUMP_DIR="{{ backup_dump_path }}"
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      mkdir -p "$DUMP_DIR"

      # PostgreSQL dumps
      for CONTAINER in $(docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | grep -E '\-db$'); do
          DB_ENGINE=$(docker exec "$CONTAINER" sh -c 'command -v pg_dump' 2>/dev/null && echo "pg" || echo "")
          if [ "$DB_ENGINE" = "pg" ]; then
              DB_USER=$(docker exec "$CONTAINER" sh -c 'echo $POSTGRES_USER' 2>/dev/null || echo "postgres")
              DB_NAME=$(docker exec "$CONTAINER" sh -c 'echo $POSTGRES_DB' 2>/dev/null || echo "")
              if [ -n "$DB_NAME" ]; then
                  echo "Dumping PostgreSQL: $CONTAINER/$DB_NAME"
                  docker exec "$CONTAINER" pg_dump -U "$DB_USER" "$DB_NAME" | gzip > "$DUMP_DIR/${CONTAINER}_${TIMESTAMP}.sql.gz"
              fi
          fi
      done

      # MariaDB/MySQL dumps
      for CONTAINER in $(docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | grep -E '\-db$'); do
          DB_ENGINE=$(docker exec "$CONTAINER" sh -c 'command -v mysqldump' 2>/dev/null && echo "mysql" || echo "")
          if [ "$DB_ENGINE" = "mysql" ]; then
              DB_NAME=$(docker exec "$CONTAINER" sh -c 'echo $MYSQL_DATABASE' 2>/dev/null || echo "")
              if [ -n "$DB_NAME" ]; then
                  echo "Dumping MySQL: $CONTAINER/$DB_NAME"
                  docker exec "$CONTAINER" mysqldump --single-transaction "$DB_NAME" | gzip > "$DUMP_DIR/${CONTAINER}_${TIMESTAMP}.sql.gz"
              fi
          fi
      done

      # Clean up dumps older than 3 days
      find "$DUMP_DIR" -name "*.sql.gz" -mtime +3 -delete
      echo "Pre-backup complete."

- name: Deploy main backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: "{{ backup_script_path }}/backup.sh"
    mode: "0700"

- name: Deploy restore helper script
  ansible.builtin.copy:
    dest: "{{ backup_script_path }}/restore.sh"
    mode: "0700"
    content: |
      #!/bin/bash
      # Restore from Restic backup
      # Usage: restore.sh <repo-url> [snapshot-id] [target-path]
      set -euo pipefail
      REPO="$1"
      SNAPSHOT="${2:-latest}"
      TARGET="${3:-/opt/restore}"
      PASSWORD_FILE="{{ backup_script_path }}/.restic-password"

      echo "Restoring snapshot $SNAPSHOT from $REPO to $TARGET..."
      mkdir -p "$TARGET"
      restic -r "$REPO" restore "$SNAPSHOT" --target "$TARGET" --password-file "$PASSWORD_FILE"
      echo "Restore complete: $TARGET"
