---
# roles/netbird-client/tasks/api_group.yml
# Create a Netbird group for a customer via REST API
# Required vars: netbird_api_url, netbird_api_token, netbird_group_name

- name: List existing Netbird groups
  ansible.builtin.uri:
    url: "{{ netbird_api_url }}/api/groups"
    method: GET
    headers:
      Authorization: "Token {{ netbird_api_token }}"
    status_code: 200
  register: nb_groups

- name: Check if group already exists
  ansible.builtin.set_fact:
    nb_existing_group: "{{ nb_groups.json | selectattr('name', 'equalto', netbird_group_name) | list | first | default(None) }}"

- name: Create Netbird group
  ansible.builtin.uri:
    url: "{{ netbird_api_url }}/api/groups"
    method: POST
    headers:
      Authorization: "Token {{ netbird_api_token }}"
    body_format: json
    body:
      name: "{{ netbird_group_name }}"
    status_code: 200
  register: nb_new_group
  when: nb_existing_group == None

- name: Set group ID fact
  ansible.builtin.set_fact:
    nb_group_id: "{{ nb_new_group.json.id if nb_existing_group == None else nb_existing_group.id }}"
