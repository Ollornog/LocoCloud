---
# roles/tinyauth/tasks/deploy.yml
# Deploy Tinyauth Docker container

- name: Create Tinyauth directory
  ansible.builtin.file:
    path: "{{ tinyauth_stack_path }}"
    state: directory
    mode: "0755"

- name: Generate Tinyauth secret
  ansible.builtin.set_fact:
    tinyauth_secret: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=48') }}"
  when: tinyauth_secret | length == 0

- name: Deploy Tinyauth docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ tinyauth_stack_path }}/docker-compose.yml"
    mode: "0644"
  notify: restart caddy

- name: Deploy Tinyauth .env
  ansible.builtin.template:
    src: env.j2
    dest: "{{ tinyauth_stack_path }}/.env"
    mode: "0600"

- name: Start Tinyauth
  community.docker.docker_compose_v2:
    project_src: "{{ tinyauth_stack_path }}"
    state: present
