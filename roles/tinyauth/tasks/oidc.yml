---
# roles/tinyauth/tasks/oidc.yml
# Register Tinyauth as OIDC client in PocketID via REST API

- name: Check if Tinyauth OIDC client already exists
  ansible.builtin.uri:
    url: "{{ pocketid_api_url }}/api/oidc/clients"
    method: GET
    headers:
      X-API-Key: "{{ pocketid_api_token }}"
    status_code: 200
  register: existing_clients
  when: pocketid_api_token | length > 0

- name: Find existing Tinyauth OIDC client
  ansible.builtin.set_fact:
    tinyauth_existing_client: "{{ existing_clients.json | selectattr('name', 'equalto', 'Tinyauth') | list | first | default(None) }}"
  when: existing_clients is defined and existing_clients.json is defined

- name: Create Tinyauth OIDC client in PocketID
  ansible.builtin.uri:
    url: "{{ pocketid_api_url }}/api/oidc/clients"
    method: POST
    headers:
      X-API-Key: "{{ pocketid_api_token }}"
    body_format: json
    body:
      name: "Tinyauth"
      callbackURLs:
        - "https://{{ tinyauth_domain }}/api/oidc/callback"
    status_code: [200, 201]
  register: tinyauth_oidc_result
  when:
    - pocketid_api_token | length > 0
    - tinyauth_existing_client is not defined or tinyauth_existing_client == None

- name: Set Tinyauth OIDC client ID
  ansible.builtin.set_fact:
    tinyauth_oidc_client_id: "{{ tinyauth_oidc_result.json.id }}"
  when: tinyauth_oidc_result is changed

- name: Set Tinyauth OIDC client ID from existing client
  ansible.builtin.set_fact:
    tinyauth_oidc_client_id: "{{ tinyauth_existing_client.id }}"
  when:
    - tinyauth_oidc_result is not changed
    - tinyauth_existing_client is defined and tinyauth_existing_client != None

- name: Generate Tinyauth OIDC client secret
  ansible.builtin.uri:
    url: "{{ pocketid_api_url }}/api/oidc/clients/{{ tinyauth_oidc_client_id }}/secret"
    method: POST
    headers:
      X-API-Key: "{{ pocketid_api_token }}"
    status_code: 200
  register: tinyauth_secret_result
  when: tinyauth_oidc_client_id is defined and tinyauth_oidc_client_id | length > 0

- name: Set Tinyauth OIDC client secret
  ansible.builtin.set_fact:
    tinyauth_oidc_client_secret: "{{ tinyauth_secret_result.json.secret }}"
  when: tinyauth_secret_result is defined and tinyauth_secret_result is not skipped

- name: Update Tinyauth .env with OIDC credentials
  ansible.builtin.template:
    src: env.j2
    dest: "{{ tinyauth_stack_path }}/.env"
    mode: "0600"
  notify: restart tinyauth
