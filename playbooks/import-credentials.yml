---
# playbooks/import-credentials.yml
# Import pending credentials into Vaultwarden via bw CLI.
#
# Prerequisites:
#   1. Vaultwarden user account created (first user via web UI)
#   2. bw CLI installed: npm install -g @bitwarden/cli
#   3. bw configured: bw config server https://vault.admin.example.com
#   4. bw logged in: bw login user@example.com
#
# Usage:
#   ansible-playbook playbooks/import-credentials.yml -i inventories/master/

- name: Import pending credentials into Vaultwarden
  hosts: all
  become: true
  gather_facts: false

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco
      tags: [always]

  vars:
    credentials_pending_file: "/root/.loco-credentials-pending.json"
    bw_appdata_dir: "/root/.bw"

  tasks:
    - name: Check if bw CLI is available
      ansible.builtin.command: which bw
      register: _bw_check
      failed_when: false
      changed_when: false

    - name: Fail if bw CLI not installed
      ansible.builtin.fail:
        msg: |
          bw CLI not found. Install it first:
            npm install -g @bitwarden/cli
            bw config server {{ loco.vaultwarden.url | default('https://vault.admin.example.com') }}
            bw login your-email@example.com
      when: _bw_check.rc != 0

    - name: Check bw login status
      ansible.builtin.command: bw status
      register: _bw_status
      changed_when: false
      environment:
        BITWARDENCLI_APPDATA_DIR: "{{ bw_appdata_dir }}"

    - name: Parse bw status
      ansible.builtin.set_fact:
        _bw_state: "{{ (_bw_status.stdout | from_json).status }}"

    - name: Fail if not logged in
      ansible.builtin.fail:
        msg: |
          bw CLI is {{ _bw_state }}. Please login first:
            bw login your-email@example.com
          Or unlock:
            bw unlock
          Then export the session:
            export BW_SESSION="..."
      when: _bw_state != 'unlocked'

    - name: Check if pending credentials file exists
      ansible.builtin.stat:
        path: "{{ credentials_pending_file }}"
      register: _pending_file

    - name: Read pending credentials
      ansible.builtin.slurp:
        src: "{{ credentials_pending_file }}"
      register: _creds_raw
      when: _pending_file.stat.exists

    - name: Parse pending credentials
      ansible.builtin.set_fact:
        _pending_creds: "{{ (_creds_raw.content | b64decode | from_json) if (_creds_raw.content | b64decode | trim | length > 0) else [] }}"
      when: _pending_file.stat.exists

    - name: No credentials to import
      ansible.builtin.debug:
        msg: "No pending credentials found in {{ credentials_pending_file }}"
      when: not _pending_file.stat.exists or (_pending_creds | default([]) | length == 0)

    - name: Import each credential
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        credential_name: "{{ item.name }}"
        credential_username: "{{ item.username }}"
        credential_password: "{{ item.password }}"
        credential_uri: "{{ item.uri | default('') }}"
        credential_notes: "{{ item.notes | default('') }}"
        credential_folder_name: "{{ item.folder | default('') }}"
      loop: "{{ _pending_creds | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      when: _pending_creds | default([]) | length > 0

    - name: Import summary
      ansible.builtin.debug:
        msg: "Imported {{ _pending_creds | default([]) | length }} credentials into Vaultwarden."
      when: _pending_creds | default([]) | length > 0
