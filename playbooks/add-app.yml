---
# playbooks/add-app.yml
# Deploy a single app to a customer server.
# Usage: ansible-playbook playbooks/add-app.yml -i inventories/kunde-abc/ \
#        -e "app_name=nextcloud"
#
# The app must exist in apps_enabled in group_vars/all.yml.

- name: "Add App"
  hosts: all:!localhost:!*proxmox*
  become: true

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - app_name is defined and app_name | length > 0
          - apps_enabled is defined and apps_enabled | length > 0
        fail_msg: "Required: -e 'app_name=nextcloud'. App must be in apps_enabled."

    - name: Find app in apps_enabled
      ansible.builtin.set_fact:
        target_app: "{{ apps_enabled | selectattr('name', 'equalto', app_name) | list | first | default(None) }}"

    - name: Fail if app not found
      ansible.builtin.fail:
        msg: "App '{{ app_name }}' not found in apps_enabled. Add it to group_vars/all.yml first."
      when: target_app == None

  tasks:
    - name: Deploy app role
      ansible.builtin.include_role:
        name: "apps/{{ target_app.name | lower | replace('-', '_') | replace(' ', '_') }}"
      vars:
        app: "{{ target_app }}"
        app_subdomain: "{{ target_app.subdomain }}"
        app_port: "{{ target_app.port }}"
        app_domain: "{{ target_app.subdomain }}.{{ kunde_domain }}"
      when: >
        (target_app.target == 'online' and server_role in ['online', 'all_in_one'])
        or (target_app.target == 'lokal' and server_role in ['app', 'apps', 'all_in_one'])
      tags: [apps]

    # Regenerate Caddyfile to include new app
    - name: Update Caddy config
      ansible.builtin.include_role:
        name: caddy
      vars:
        caddy_mode: "customer"
      when: server_role in ['online', 'gateway', 'all_in_one']
      tags: [caddy]

    # Deploy Watchtower if not already present
    - name: Ensure Watchtower is running
      ansible.builtin.include_role:
        name: watchtower
      tags: [watchtower]

    - name: App deployed
      ansible.builtin.debug:
        msg: |
          App {{ app_name }} deployed!
          URL: https://{{ target_app.subdomain }}.{{ kunde_domain }}
          Port: {{ target_app.port }}
