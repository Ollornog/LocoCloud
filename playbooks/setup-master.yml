---
# playbooks/setup-master.yml
# Initial setup of the Master-LXC with all admin services.
# Usage: ansible-playbook playbooks/setup-master.yml -i inventories/master/
#
# Order matters:
#   1. base       — OS hardening, Docker, UFW, Fail2ban
#   2. netbird    — VPN connectivity (everything after this uses Netbird)
#   3. pocketid   — OIDC provider (needed before Tinyauth)
#   4. tinyauth   — Forward-auth (needs PocketID OIDC client)
#   5. vaultwarden — Credential store (needed before credentials role)
#   6. semaphore  — Ansible Web-UI
#   7. grafana    — Monitoring stack (Grafana + Prometheus + Loki)
#   8. baserow    — Permission management (Berechtigungskonzept)
#   9. caddy      — Reverse proxy (last: needs all backends running)

- name: Setup Master Server
  hosts: all
  become: true
  vars:
    # Local PocketID API URL for server-to-server calls during bootstrap.
    # Public URL is not resolvable until DNS/Caddy are configured.
    pocketid_api_url: "http://127.0.0.1:{{ pocketid_port | default(1411) }}"
    # Initial token from config — PocketID role may auto-generate and override via set_fact.
    # Do NOT re-assign this in downstream role vars, or it overwrites the generated value.
    pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

  roles:
    - role: base
      tags: [base]

    - role: netbird_client
      vars:
        netbird_setup_key: "{{ vault_master_netbird_setup_key | default('') }}"
        netbird_management_url: "{{ loco.netbird.manager_url | default('') }}"
      tags: [netbird]
      when: loco.netbird.enabled | default(false)

    - role: pocketid
      vars:
        pocketid_domain: "{{ loco.urls.pocketid }}"
      tags: [pocketid]

    - role: tinyauth
      vars:
        tinyauth_domain: "{{ loco.urls.tinyauth }}"
        tinyauth_oidc_issuer_url: "https://{{ loco.urls.pocketid }}"
        tinyauth_oauth_whitelist:
          - "{{ loco.operator.email }}"
      tags: [tinyauth]

    - role: apps/vaultwarden
      vars:
        vaultwarden_domain: "{{ loco.urls.vaultwarden }}"
        vaultwarden_smtp_host: "{{ loco.smtp.host | default('') }}"
        vaultwarden_smtp_port: "{{ loco.smtp.port | default(587) }}"
        vaultwarden_smtp_username: "{{ loco.smtp.user | default('') }}"
        vaultwarden_smtp_from: "{{ loco.smtp.from | default('') }}"
        pocketid_domain: "{{ loco.urls.pocketid }}"
        caddy_mode: "master"
      tags: [vaultwarden]

    - role: apps/semaphore
      vars:
        semaphore_domain: "{{ loco.urls.semaphore }}"
        semaphore_admin_email: "{{ loco.operator.email }}"
      tags: [semaphore]

    - role: grafana_stack
      vars:
        grafana_domain: "{{ loco.urls.grafana }}"
        grafana_admin_password: "{{ loco.grafana.admin_password | default('') }}"
        prometheus_retention: "{{ loco.grafana.prometheus_retention | default('30d') }}"
        loki_retention_period: "{{ loco.grafana.loki_retention | default('4320h') }}"
        grafana_smtp_enabled: "{{ loco.smtp.host | default('') | length > 0 }}"
        grafana_smtp_host: "{{ loco.smtp.host | default('') }}"
        grafana_smtp_port: "{{ loco.smtp.port | default(587) }}"
        grafana_smtp_user: "{{ loco.smtp.user | default('') }}"
        grafana_smtp_from: "{{ loco.smtp.from | default('') }}"
        grafana_alert_email_to: "{{ loco.grafana.alerting.email_to | default(loco.operator.email) }}"
      tags: [grafana, monitoring]

    - role: baserow
      vars:
        baserow_domain: "{{ loco.urls.baserow }}"
        baserow_admin_email: "{{ loco.baserow.admin_email | default(loco.operator.email) }}"
      tags: [baserow]

    - role: caddy
      vars:
        caddy_mode: "master"
      tags: [caddy]

  post_tasks:
    - name: Store PocketID API token in Vaultwarden
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "https://{{ loco.urls.vaultwarden }}"
        credential_name: "Master — PocketID API Token"
        credential_username: "STATIC_API_KEY"
        credential_password: "{{ pocketid_api_token }}"
        credential_uri: "https://{{ loco.urls.pocketid }}"
        credential_notes: "PocketID static API key for automation. Deployed: {{ ansible_facts.date_time.iso8601 }}"
      when: pocketid_api_token is defined and pocketid_api_token | length > 0
      tags: [credentials]

    - name: Store Semaphore admin credentials in Vaultwarden
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "https://{{ loco.urls.vaultwarden }}"
        credential_name: "Master — Semaphore Admin"
        credential_username: "{{ semaphore_admin_user | default('admin') }}"
        credential_password: "{{ semaphore_admin_password }}"
        credential_uri: "https://{{ loco.urls.semaphore }}"
        credential_notes: "Semaphore admin account. Deployed: {{ ansible_facts.date_time.iso8601 }}"
      when: semaphore_admin_password is defined
      tags: [credentials]

    - name: Store Grafana admin credentials in Vaultwarden
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "https://{{ loco.urls.vaultwarden }}"
        credential_name: "Master — Grafana Admin"
        credential_username: "{{ grafana_admin_user | default('admin') }}"
        credential_password: "{{ grafana_admin_password }}"
        credential_uri: "https://{{ loco.urls.grafana }}"
        credential_notes: "Grafana admin account. Deployed: {{ ansible_facts.date_time.iso8601 }}"
      when: grafana_admin_password is defined
      tags: [credentials]

    - name: Store Baserow admin credentials in Vaultwarden
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "https://{{ loco.urls.vaultwarden }}"
        credential_name: "Master — Baserow Admin"
        credential_username: "{{ baserow_admin_email | default(loco.operator.email) }}"
        credential_password: "{{ baserow_admin_password }}"
        credential_uri: "https://{{ loco.urls.baserow }}"
        credential_notes: "Baserow admin account. Deployed: {{ ansible_facts.date_time.iso8601 }}"
      when: baserow_admin_password is defined
      tags: [credentials]

    - name: Master setup complete
      ansible.builtin.debug:
        msg: |
          Master setup complete!
          PocketID:    https://{{ loco.urls.pocketid }}
          Tinyauth:    https://{{ loco.urls.tinyauth }}
          Vaultwarden: https://{{ loco.urls.vaultwarden }}
          Semaphore:   https://{{ loco.urls.semaphore }}
          Grafana:     https://{{ loco.urls.grafana }}
          Baserow:     https://{{ loco.urls.baserow }}
