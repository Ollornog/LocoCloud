---
# playbooks/site.yml
# Full deploy — base + auth stack + all enabled apps for a customer.
# Idempotent: safe to run multiple times.
# Usage: ansible-playbook playbooks/site.yml -i inventories/kunde-abc/
#
# Handles all variants: cloud_only, hybrid, lokal_only.
# For hybrid/lokal_only: LXCs must already exist (run onboard-customer.yml first).

- name: "Full Deploy — Base + Auth + Apps"
  hosts: all:!localhost:!*proxmox*
  become: true

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

  roles:
    # OS hardening + Docker
    - role: base
      tags: [base]

    # Netbird VPN
    - role: netbird_client
      vars:
        netbird_setup_key: "{{ netbird_setup_keys.online | default(netbird_setup_keys.lokal | default('')) }}"
        netbird_management_url: "{{ loco.netbird.manager_url }}"
      tags: [netbird]

    # Auth stack (only on entry-point servers)
    - role: pocketid
      vars:
        pocketid_domain: "id.{{ kunde_domain }}"
        pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"
      tags: [pocketid]
      when: server_role in ['online', 'gateway', 'all_in_one']

    - role: tinyauth
      vars:
        tinyauth_domain: "auth.{{ kunde_domain }}"
        tinyauth_oidc_issuer_url: "https://id.{{ kunde_domain }}"
        tinyauth_oauth_whitelist: "{{ [loco.operator.email] + (kunden_emails | default([])) }}"
        pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"
      tags: [tinyauth]
      when: server_role in ['online', 'gateway', 'all_in_one']

    # Watchtower on all servers with Docker
    - role: watchtower
      tags: [watchtower]

    # Monitoring (Zabbix Agent)
    - role: monitoring
      vars:
        zabbix_server_ip: "{{ loco.monitoring.zabbix_server_ip | default('') }}"
      tags: [monitoring]
      when: loco.monitoring.zabbix_server_ip | default('') | length > 0

    # Backup (Restic)
    - role: backup
      tags: [backup]
      when: backup.enabled | default(false)

  tasks:
    # Deploy each enabled app
    - name: Deploy apps
      ansible.builtin.include_role:
        name: "apps/{{ item.name | lower | replace('-', '_') | replace(' ', '_') }}"
      vars:
        app: "{{ item }}"
        app_name: "{{ item.name }}"
        app_subdomain: "{{ item.subdomain }}"
        app_port: "{{ item.port }}"
        app_domain: "{{ item.subdomain }}.{{ kunde_domain }}"
      loop: "{{ apps_enabled | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      when: >
        (item.target == 'online' and server_role in ['online', 'all_in_one'])
        or (item.target == 'lokal' and server_role in ['app', 'apps', 'all_in_one'])
      tags: [apps]

    # Regenerate Caddyfile after all apps are deployed
    - name: Deploy Caddy with updated Caddyfile
      ansible.builtin.include_role:
        name: caddy
      vars:
        caddy_mode: "customer"
      when: server_role in ['online', 'gateway', 'all_in_one']
      tags: [caddy]
