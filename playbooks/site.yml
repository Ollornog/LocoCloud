---
# playbooks/site.yml
# Full deploy — base + auth stack + all enabled apps for a customer.
# Idempotent: safe to run multiple times.
# Usage: ansible-playbook playbooks/site.yml -i inventories/kunde-abc/
#
# Supports any combination of server_roles per host.
# For hosts with proxmox LXCs: LXCs must already exist (run onboard-customer.yml first).

- name: "Full Deploy — Base + Auth + Apps"
  hosts: all:!localhost:!*proxmox*
  become: true
  vars:
    # Initial token from config — PocketID role may auto-generate and override via set_fact.
    pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

  roles:
    # OS hardening + Docker
    - role: base
      tags: [base]

    # Netbird VPN (optional)
    - role: netbird_client
      vars:
        netbird_setup_key: "{{ netbird_setup_key | default('') }}"
        netbird_management_url: "{{ loco.netbird.manager_url | default('') }}"
      tags: [netbird]
      when: loco.netbird.enabled | default(false)

    # gocryptfs encryption for /mnt/data
    - role: gocryptfs
      vars:
        gocryptfs_master_host: "{{ loco.admin.full_domain | default('') }}"
      tags: [gocryptfs]
      when: "'backup_server' not in (server_roles | default([]))"

    # Auth stack (only on hosts with customer_master role)
    - role: pocketid
      vars:
        pocketid_domain: "id.{{ kunde_domain }}"
      tags: [pocketid]
      when: "'customer_master' in server_roles"

    - role: tinyauth
      vars:
        tinyauth_domain: "auth.{{ kunde_domain }}"
        tinyauth_oidc_issuer_url: "https://id.{{ kunde_domain }}"
        tinyauth_oauth_whitelist: "{{ [loco.operator.email] + (kunden_emails | default([])) }}"
      tags: [tinyauth]
      when: "'customer_master' in server_roles"

    # Watchtower on all servers with Docker
    - role: watchtower
      tags: [watchtower]

    # Monitoring (Grafana Alloy agent)
    - role: monitoring
      vars:
        monitoring_prometheus_url: "{{ loco.grafana.prometheus_remote_write_url | default('') }}"
        monitoring_loki_url: "{{ loco.grafana.loki_push_url | default('') }}"
        monitoring_instance_label: "{{ inventory_hostname }}"
        monitoring_kunde_label: "{{ kunde_id | default('') }}"
      tags: [monitoring, alloy]

    # Backup (Restic)
    - role: backup
      tags: [backup]
      when: backup.enabled | default(false)

  tasks:
    # Deploy each enabled app (on hosts with app_server role)
    - name: Deploy apps
      ansible.builtin.include_role:
        name: "apps/{{ item.name | lower | replace('-', '_') | replace(' ', '_') }}"
      vars:
        app: "{{ item }}"
        app_name: "{{ item.name }}"
        app_subdomain: "{{ item.subdomain }}"
        app_port: "{{ item.port }}"
        app_domain: "{{ item.subdomain }}.{{ kunde_domain }}"
      loop: "{{ apps_enabled | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      when: "'app_server' in server_roles"
      tags: [apps]

    # Regenerate Caddyfile after all apps are deployed
    - name: Deploy Caddy with updated Caddyfile
      ansible.builtin.include_role:
        name: caddy
      vars:
        caddy_mode: "customer"
      when: "'gateway' in server_roles"
      tags: [caddy]
