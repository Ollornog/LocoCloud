---
# playbooks/onboard-customer.yml
# Onboard a new customer — creates Netbird resources, deploys auth stack + Caddy.
# Usage: ansible-playbook playbooks/onboard-customer.yml -i inventories/kunde-abc/
#
# Supports all three variants:
#   - cloud_only:  Play 1 (Netbird API) → Play 2 (Entry-Point on Hetzner)
#   - hybrid:      Play 1 → Play 2 (Hetzner) → Play 3 (LXCs on Proxmox)
#   - lokal_only:  Play 1 → Play 3 (LXCs) → Play 4 (Gateway-LXC as entry-point)

# =====================================================
# Play 1: Netbird API setup (runs on localhost/master)
# =====================================================
- name: "Onboarding — Netbird API Setup"
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

  tasks:
    # Find loco-admin group ID
    - name: Get loco-admin group ID
      ansible.builtin.uri:
        url: "{{ loco.netbird.manager_url }}/api/groups"
        method: GET
        headers:
          Authorization: "Token {{ loco.netbird.api_token }}"
        status_code: 200
      register: nb_all_groups

    - name: Set loco-admin group ID
      ansible.builtin.set_fact:
        loco_admin_group_id: "{{ nb_all_groups.json | selectattr('name', 'equalto', 'loco-admin') | map(attribute='id') | first | default('') }}"

    # Create customer group
    - name: Create Netbird customer group
      ansible.builtin.include_role:
        name: netbird_client
        tasks_from: api_group.yml
      vars:
        netbird_api_url: "{{ loco.netbird.manager_url }}"
        netbird_api_token: "{{ loco.netbird.api_token }}"
        netbird_group_name: "kunde-{{ kunde_id }}"

    # Create policies
    - name: Create Netbird policies
      ansible.builtin.include_role:
        name: netbird_client
        tasks_from: api_policies.yml
      vars:
        netbird_api_url: "{{ loco.netbird.manager_url }}"
        netbird_api_token: "{{ loco.netbird.api_token }}"
        backup_enabled: "{{ backup.enabled | default(false) }}"

    # Generate setup key
    - name: Generate Netbird setup key
      ansible.builtin.include_role:
        name: netbird_client
        tasks_from: api_setup_key.yml
      vars:
        netbird_api_url: "{{ loco.netbird.manager_url }}"
        netbird_api_token: "{{ loco.netbird.api_token }}"

    # Store setup key in Vaultwarden
    - name: Store Netbird setup key in Vaultwarden
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "{{ loco.vaultwarden.url }}"
        credential_name: "{{ kunde_name }} — Netbird Setup Key"
        credential_username: "kunde-{{ kunde_id }}"
        credential_password: "{{ nb_generated_setup_key }}"
        credential_notes: "Netbird setup key for onboarding. Expires in 24h. Generated: {{ ansible_date_time.iso8601 | default('N/A') }}"

# =====================================================
# Play 2: Deploy on customer entry-point server
# =====================================================
- name: "Onboarding — Entry-Point Setup"
  hosts: all:!localhost:!*proxmox*
  become: true

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

  roles:
    # 1. OS hardening + Docker
    - role: base
      tags: [base]

    # 2. Netbird VPN
    - role: netbird_client
      vars:
        netbird_setup_key: "{{ netbird_setup_keys.online | default('') }}"
        netbird_management_url: "{{ loco.netbird.manager_url }}"
      tags: [netbird]

    # 3. PocketID (customer instance)
    - role: pocketid
      vars:
        pocketid_domain: "id.{{ kunde_domain }}"
        pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"
      tags: [pocketid]
      when: server_role in ['online', 'gateway', 'all_in_one']

    # 4. Tinyauth (customer instance)
    - role: tinyauth
      vars:
        tinyauth_domain: "auth.{{ kunde_domain }}"
        tinyauth_oidc_issuer_url: "https://id.{{ kunde_domain }}"
        tinyauth_oauth_whitelist: "{{ [loco.operator.email] + (kunden_emails | default([])) }}"
        pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"
      tags: [tinyauth]
      when: server_role in ['online', 'gateway', 'all_in_one']

    # 5. Caddy (customer Caddyfile)
    - role: caddy
      vars:
        caddy_mode: "customer"
      tags: [caddy]
      when: server_role in ['online', 'gateway', 'all_in_one']

  post_tasks:
    # Store credentials
    - name: Create Vaultwarden folder for customer
      ansible.builtin.include_role:
        name: credentials
        tasks_from: create_folder.yml
      vars:
        vw_api_url: "{{ loco.vaultwarden.url }}"
        credential_folder_name: "{{ kunde_name }} ({{ kunde_domain }})"
      tags: [credentials]

    - name: Store PocketID admin credentials
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "{{ loco.vaultwarden.url }}"
        credential_name: "{{ kunde_name }} — PocketID Admin"
        credential_username: "admin"
        credential_password: "{{ pocketid_admin_password }}"
        credential_uri: "https://id.{{ kunde_domain }}"
        credential_notes: "PocketID admin for {{ kunde_name }}. Deployed: {{ ansible_date_time.iso8601 }}"
      when: pocketid_admin_password is defined
      tags: [credentials]

    - name: Store Tinyauth secret
      ansible.builtin.include_role:
        name: credentials
        tasks_from: store.yml
      vars:
        vw_api_url: "{{ loco.vaultwarden.url }}"
        credential_name: "{{ kunde_name }} — Tinyauth Secret"
        credential_username: "tinyauth"
        credential_password: "{{ tinyauth_secret }}"
        credential_uri: "https://auth.{{ kunde_domain }}"
        credential_notes: "Tinyauth session secret. Deployed: {{ ansible_date_time.iso8601 }}"
      when: tinyauth_secret is defined
      tags: [credentials]

    # Create admin user in customer PocketID
    - name: Create admin user in customer PocketID
      ansible.builtin.uri:
        url: "https://id.{{ kunde_domain }}/api/users"
        method: POST
        headers:
          Authorization: "Bearer {{ loco.pocketid.api_token }}"
        body_format: json
        body:
          username: "admin"
          email: "{{ loco.operator.email }}"
          first_name: "{{ loco.operator.name | default('Admin') }}"
          last_name: "LocoCloud"
        status_code: [200, 201, 409]
      when: loco.pocketid.api_token | default('') | length > 0
      tags: [pocketid, users]

    # Create customer users in PocketID
    - name: Create customer users in PocketID
      ansible.builtin.uri:
        url: "https://id.{{ kunde_domain }}/api/users"
        method: POST
        headers:
          Authorization: "Bearer {{ loco.pocketid.api_token }}"
        body_format: json
        body:
          username: "{{ item.username }}"
          email: "{{ item.email }}"
          first_name: "{{ item.display_name | split(' ') | first | default(item.username) }}"
          last_name: "{{ item.display_name | split(' ') | last | default('') }}"
        status_code: [200, 201, 409]
      loop: "{{ kunden_users | default([]) }}"
      when: loco.pocketid.api_token | default('') | length > 0
      tags: [pocketid, users]

    # Smoke test
    - name: Smoke test — PocketID reachable
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ pocketid_port | default(1411) }}/.well-known/openid-configuration"
        method: GET
        status_code: 200
      tags: [test]

    - name: Entry-point onboarding complete
      ansible.builtin.debug:
        msg: |
          Entry-point onboarding complete!
          Customer: {{ kunde_name }} ({{ kunde_domain }})
          PocketID:  https://id.{{ kunde_domain }}
          Tinyauth:  https://auth.{{ kunde_domain }}
          Next: Deploy apps with site.yml or add-app.yml

# =====================================================
# Play 3: Create LXCs on Proxmox (hybrid + lokal_only)
# =====================================================
- name: "Onboarding — Proxmox LXC Creation"
  hosts: "*proxmox*"
  become: true
  gather_facts: false

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

    - name: Load customer config
      ansible.builtin.include_vars:
        file: "{{ inventory_dir }}/group_vars/all.yml"

  tasks:
    - name: Skip if cloud_only
      ansible.builtin.meta: end_play
      when: variante | default('cloud_only') == 'cloud_only'

    # Create LXCs for each app with target=lokal (lxc_per_app mode)
    - name: Create app LXCs (lxc_per_app)
      ansible.builtin.include_role:
        name: lxc_create
      vars:
        lxc_vmid: "{{ item.lxc_vmid }}"
        lxc_hostname: "{{ kunde_id }}-{{ item.name | lower | replace(' ', '-') }}"
        lxc_disk_size: "{{ item.disk_size | default(16) }}"
        lxc_cores: "{{ item.cores | default(2) }}"
        lxc_memory: "{{ item.memory | default(2048) }}"
        proxmox_host: "{{ inventory_hostname }}"
        netbird_setup_key: "{{ hostvars['localhost']['nb_generated_setup_key'] | default(netbird_setup_keys.lokal | default('')) }}"
        netbird_management_url: "{{ loco.netbird.manager_url }}"
      loop: "{{ apps_enabled | selectattr('target', 'equalto', 'lokal') | list }}"
      loop_control:
        label: "{{ item.name }}"
      when:
        - isolation_mode | default('single_lxc') == 'lxc_per_app'
        - item.lxc_vmid is defined
      tags: [lxc, proxmox]

    # Create single LXC for all local apps (single_lxc mode)
    - name: Create single LXC for all apps
      ansible.builtin.include_role:
        name: lxc_create
      vars:
        lxc_vmid: "{{ single_lxc_vmid | default(200) }}"
        lxc_hostname: "{{ kunde_id }}-apps"
        lxc_disk_size: "{{ single_lxc_disk | default(32) }}"
        lxc_cores: "{{ single_lxc_cores | default(4) }}"
        lxc_memory: "{{ single_lxc_memory | default(4096) }}"
        proxmox_host: "{{ inventory_hostname }}"
        netbird_setup_key: "{{ hostvars['localhost']['nb_generated_setup_key'] | default(netbird_setup_keys.lokal | default('')) }}"
        netbird_management_url: "{{ loco.netbird.manager_url }}"
      when:
        - isolation_mode | default('single_lxc') == 'single_lxc'
        - apps_enabled | selectattr('target', 'equalto', 'lokal') | list | length > 0
      tags: [lxc, proxmox]

    # Create Gateway-LXC for lokal_only variant
    - name: Create Gateway LXC (lokal_only)
      ansible.builtin.include_role:
        name: lxc_create
      vars:
        lxc_vmid: "{{ gateway_lxc_vmid | default(100) }}"
        lxc_hostname: "{{ kunde_id }}-gateway"
        lxc_disk_size: "{{ gateway_lxc_disk | default(8) }}"
        lxc_cores: "{{ gateway_lxc_cores | default(2) }}"
        lxc_memory: "{{ gateway_lxc_memory | default(2048) }}"
        proxmox_host: "{{ inventory_hostname }}"
        netbird_setup_key: "{{ hostvars['localhost']['nb_generated_setup_key'] | default(netbird_setup_keys.lokal | default('')) }}"
        netbird_management_url: "{{ loco.netbird.manager_url }}"
      when: variante == 'lokal_only'
      tags: [lxc, proxmox, gateway]

    - name: LXC creation complete
      ansible.builtin.debug:
        msg: |
          Proxmox LXC creation complete for {{ kunde_name }}.
          Created LXCs are now reachable via Netbird.
          Next: Run base + app roles on each LXC via site.yml.

# =====================================================
# Play 4: Setup Gateway-LXC (lokal_only only)
# =====================================================
- name: "Onboarding — Gateway LXC Setup (lokal_only)"
  hosts: "*gateway*"
  become: true

  pre_tasks:
    - name: Load global config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../config/lococloudd.yml"
        name: loco

    - name: Skip if not lokal_only
      ansible.builtin.meta: end_play
      when: variante | default('cloud_only') != 'lokal_only'

  roles:
    - role: base
      tags: [base]

    - role: pocketid
      vars:
        pocketid_domain: "id.{{ kunde_domain }}"
        pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"
      tags: [pocketid]

    - role: tinyauth
      vars:
        tinyauth_domain: "auth.{{ kunde_domain }}"
        tinyauth_oidc_issuer_url: "https://id.{{ kunde_domain }}"
        tinyauth_oauth_whitelist: "{{ [loco.operator.email] + (kunden_emails | default([])) }}"
        pocketid_api_token: "{{ loco.pocketid.api_token | default('') }}"
      tags: [tinyauth]

    - role: caddy
      vars:
        caddy_mode: "customer"
      tags: [caddy]

  post_tasks:
    - name: Gateway setup complete
      ansible.builtin.debug:
        msg: |
          Gateway-LXC setup complete for lokal_only customer {{ kunde_name }}.
          PocketID: https://id.{{ kunde_domain }}
          Tinyauth: https://auth.{{ kunde_domain }}
          IMPORTANT: Configure port-forward 80/443 on customer router to this LXC.
          {% if dyndns.enabled | default(false) %}
          DynDNS is enabled — DNS will be updated automatically.
          {% else %}
          DynDNS is NOT enabled — configure a static IP or DynDNS manually.
          {% endif %}
